FROM node:20-alpine

RUN apk add --no-cache netcat-openbsd openssl
WORKDIR /back
COPY package*.json ./
RUN npm install
COPY . .
EXPOSE 3001
CMD sh -lc '\
  echo "[wait-db] waiting for mysql-sentinel:3306..." && \
  until nc -z mysql-sentinel 3306; do sleep 1; done && \
  echo "[wait-db] DB is ready, running prisma..." && \
  npx prisma generate && \
  npx prisma migrate dev --name "Setup sentinel db" --skip-generate || true && \
  npx prisma db seed || true && \
  echo "[start] starting Nest (debug)..." && \
  npm run start:debug \
'

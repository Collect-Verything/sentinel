# ğŸ“‘ 4.0 â€” Bootstrap server (idempotent)

Ce job a pour but de **prÃ©parer le serveur Sentinel** automatiquement.
ğŸ‘‰ Il installe les dÃ©pendances nÃ©cessaires, configure Docker (sâ€™il nâ€™est pas dÃ©jÃ  installÃ©), et garantit que la machine est prÃªte Ã  exÃ©cuter notre stack monitoring.
Il est dit **idempotent** car il peut Ãªtre relancÃ© plusieurs fois sans â€œcasserâ€ la config.

---

### ğŸ”¹ Structure gÃ©nÃ©rale

```yaml
- name: Bootstrap server (idempotent)
  uses: appleboy/ssh-action@v1.0.0
#  Checker le docker compose dans sentinel/
```

* On utilise lâ€™action GitHub **appleboy/ssh-action** â†’ permet dâ€™exÃ©cuter des commandes sur un serveur distant via SSH.
* Les credentials (hÃ´te, user, password) viennent de nos **secrets & variables** (voir fiche 3.0).
* Tout ce qui est sous `script: |` est exÃ©cutÃ© **cÃ´tÃ© serveur**.

---

### ğŸ”¹ DÃ©but du script

```bash
set -euo pipefail
export DEBIAN_FRONTEND=noninteractive
```

* `set -euo pipefail` â†’ Active des rÃ¨gles strictes :

    * `-e` : le script sâ€™arrÃªte Ã  la **premiÃ¨re erreur**.
    * `-u` : interdit lâ€™utilisation de variables non dÃ©finies.
    * `-o pipefail` : en cas de pipeline (`cmd1 | cmd2`), si **une seule commande Ã©choue**, tout Ã©choue.
      ğŸ‘‰ Câ€™est une **sÃ©curisation**, Ã©vite les demi-installations.

* `export DEBIAN_FRONTEND=noninteractive` â†’ empÃªche `apt` de poser des questions interactives (genre â€œVoulez-vous continuer ?â€).
  ğŸ‘‰ Indispensable pour les scripts automatisÃ©s.

---

### ğŸ”¹ Mise Ã  jour systÃ¨me

```bash
echo "==> APT update/upgrade"
apt-get update -y
apt-get upgrade -y || true
apt-get install -y ca-certificates curl gnupg lsb-release rsync jq
```

* `apt-get update -y` â†’ met Ã  jour la liste des paquets disponibles.
* `apt-get upgrade -y || true` â†’ met Ã  jour les paquets installÃ©s, mais **`|| true`** empÃªche le script de sâ€™arrÃªter si une mise Ã  jour Ã©choue.
* `apt-get install -y ...` â†’ installe des outils essentiels :

    * `ca-certificates` â†’ certificats SSL/TLS, nÃ©cessaires pour les connexions HTTPS.
    * `curl` â†’ pour tÃ©lÃ©charger des fichiers via HTTP/HTTPS.
    * `gnupg` â†’ gestion des clÃ©s GPG (signatures).
    * `lsb-release` â†’ permet dâ€™obtenir la version de lâ€™OS (`UBUNTU_CODENAME`).
    * `rsync` â†’ copie/synchro de fichiers (utilisÃ© plus tard).
    * `jq` â†’ parseur JSON pratique (debug ou automatisation).

---

### ğŸ”¹ Installation de Docker (si absent)

```bash
echo "==> Install Docker Engine + Compose v2 if missing"
if ! command -v docker >/dev/null 2>&1; then
  install -m 0755 -d /etc/apt/keyrings
  curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
  chmod a+r /etc/apt/keyrings/docker.gpg
  echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
  https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo $UBUNTU_CODENAME) stable" \
  > /etc/apt/sources.list.d/docker.list
  apt-get update -y
  apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
  systemctl enable --now docker
fi
```

ğŸ‘‰ Ce bloc vÃ©rifie si Docker est installÃ© :

* `if ! command -v docker >/dev/null 2>&1; then`
  â†’ Si la commande `docker` nâ€™existe pas, alors on installe Docker.

Ã‰tapes dâ€™installation :

1. `install -m 0755 -d /etc/apt/keyrings`
   â†’ crÃ©e un dossier pour stocker la clÃ© GPG de Docker.

2. `curl -fsSL ... | gpg --dearmor -o /etc/apt/keyrings/docker.gpg`
   â†’ tÃ©lÃ©charge la clÃ© GPG officielle de Docker et la stocke au bon format.

3. `chmod a+r /etc/apt/keyrings/docker.gpg`
   â†’ rend la clÃ© lisible pour tous.

4. `echo "deb ... > /etc/apt/sources.list.d/docker.list`
   â†’ ajoute le dÃ©pÃ´t officiel Docker dans les sources APT.

5. `apt-get update -y`
   â†’ recharge la liste des paquets (incluant Docker).

6. `apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin`
   â†’ installe Docker **et Compose v2**.

7. `systemctl enable --now docker`
   â†’ active Docker au dÃ©marrage et le lance immÃ©diatement.

âš¡ RÃ©sultat : si Docker Ã©tait dÃ©jÃ  installÃ©, on ne touche Ã  rien.
Sinon â†’ installation propre.

---

### ğŸ”¹ VÃ©rification des versions

```bash
echo "==> Docker versions"
docker --version
docker compose version
```

* `docker --version` â†’ affiche la version du moteur Docker.
* `docker compose version` â†’ affiche la version de **Docker Compose v2** (intÃ©grÃ© en plugin).

ğŸ‘‰ VÃ©rifie que Docker est prÃªt Ã  Ãªtre utilisÃ©.

---

### ğŸ”¹ Fin du script

```bash
echo "==> Done."
```

Simple message de confirmation que le job de **bootstrap est terminÃ© avec succÃ¨s** âœ….

---

## ğŸ¯ En rÃ©sumÃ©

Le job **Bootstrap** :

1. SÃ©curise lâ€™exÃ©cution (`set -euo pipefail`).
2. Met Ã  jour le serveur (`apt-get update/upgrade`).
3. Installe les dÃ©pendances de base (`curl`, `rsync`, `jq`, etc.).
4. VÃ©rifie si Docker est installÃ© â†’ sinon installe **Docker + Compose v2**.
5. Active Docker comme service systÃ¨me.
6. VÃ©rifie les versions installÃ©es.
7. Confirme la fin.

ğŸ‘‰ GrÃ¢ce Ã  lâ€™**idempotence**, on peut relancer ce job 100 fois :
si Docker et les dÃ©pendances sont dÃ©jÃ  lÃ  â†’ rien ne casse.

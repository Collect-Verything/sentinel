# 📑 4.0 — Bootstrap server (idempotent)

Ce job a pour but de **préparer le serveur Sentinel** automatiquement.
👉 Il installe les dépendances nécessaires, configure Docker (s’il n’est pas déjà installé), et garantit que la machine est prête à exécuter notre stack monitoring.
Il est dit **idempotent** car il peut être relancé plusieurs fois sans “casser” la config.

---

### 🔹 Structure générale

```yaml
- name: Bootstrap server (idempotent)
  uses: appleboy/ssh-action@v1.0.0
#  Checker le docker compose dans sentinel/
```

* On utilise l’action GitHub **appleboy/ssh-action** → permet d’exécuter des commandes sur un serveur distant via SSH.
* Les credentials (hôte, user, password) viennent de nos **secrets & variables** (voir fiche 3.0).
* Tout ce qui est sous `script: |` est exécuté **côté serveur**.

---

### 🔹 Début du script

```bash
set -euo pipefail
export DEBIAN_FRONTEND=noninteractive
```

* `set -euo pipefail` → Active des règles strictes :

    * `-e` : le script s’arrête à la **première erreur**.
    * `-u` : interdit l’utilisation de variables non définies.
    * `-o pipefail` : en cas de pipeline (`cmd1 | cmd2`), si **une seule commande échoue**, tout échoue.
      👉 C’est une **sécurisation**, évite les demi-installations.

* `export DEBIAN_FRONTEND=noninteractive` → empêche `apt` de poser des questions interactives (genre “Voulez-vous continuer ?”).
  👉 Indispensable pour les scripts automatisés.

---

### 🔹 Mise à jour système

```bash
echo "==> APT update/upgrade"
apt-get update -y
apt-get upgrade -y || true
apt-get install -y ca-certificates curl gnupg lsb-release rsync jq
```

* `apt-get update -y` → met à jour la liste des paquets disponibles.
* `apt-get upgrade -y || true` → met à jour les paquets installés, mais **`|| true`** empêche le script de s’arrêter si une mise à jour échoue.
* `apt-get install -y ...` → installe des outils essentiels :

    * `ca-certificates` → certificats SSL/TLS, nécessaires pour les connexions HTTPS.
    * `curl` → pour télécharger des fichiers via HTTP/HTTPS.
    * `gnupg` → gestion des clés GPG (signatures).
    * `lsb-release` → permet d’obtenir la version de l’OS (`UBUNTU_CODENAME`).
    * `rsync` → copie/synchro de fichiers (utilisé plus tard).
    * `jq` → parseur JSON pratique (debug ou automatisation).

---

### 🔹 Installation de Docker (si absent)

```bash
echo "==> Install Docker Engine + Compose v2 if missing"
if ! command -v docker >/dev/null 2>&1; then
  install -m 0755 -d /etc/apt/keyrings
  curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
  chmod a+r /etc/apt/keyrings/docker.gpg
  echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
  https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo $UBUNTU_CODENAME) stable" \
  > /etc/apt/sources.list.d/docker.list
  apt-get update -y
  apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
  systemctl enable --now docker
fi
```

👉 Ce bloc vérifie si Docker est installé :

* `if ! command -v docker >/dev/null 2>&1; then`
  → Si la commande `docker` n’existe pas, alors on installe Docker.

Étapes d’installation :

1. `install -m 0755 -d /etc/apt/keyrings`
   → crée un dossier pour stocker la clé GPG de Docker.

2. `curl -fsSL ... | gpg --dearmor -o /etc/apt/keyrings/docker.gpg`
   → télécharge la clé GPG officielle de Docker et la stocke au bon format.

3. `chmod a+r /etc/apt/keyrings/docker.gpg`
   → rend la clé lisible pour tous.

4. `echo "deb ... > /etc/apt/sources.list.d/docker.list`
   → ajoute le dépôt officiel Docker dans les sources APT.

5. `apt-get update -y`
   → recharge la liste des paquets (incluant Docker).

6. `apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin`
   → installe Docker **et Compose v2**.

7. `systemctl enable --now docker`
   → active Docker au démarrage et le lance immédiatement.

⚡ Résultat : si Docker était déjà installé, on ne touche à rien.
Sinon → installation propre.

---

### 🔹 Vérification des versions

```bash
echo "==> Docker versions"
docker --version
docker compose version
```

* `docker --version` → affiche la version du moteur Docker.
* `docker compose version` → affiche la version de **Docker Compose v2** (intégré en plugin).

👉 Vérifie que Docker est prêt à être utilisé.

---

### 🔹 Fin du script

```bash
echo "==> Done."
```

Simple message de confirmation que le job de **bootstrap est terminé avec succès** ✅.

---

## 🎯 En résumé

Le job **Bootstrap** :

1. Sécurise l’exécution (`set -euo pipefail`).
2. Met à jour le serveur (`apt-get update/upgrade`).
3. Installe les dépendances de base (`curl`, `rsync`, `jq`, etc.).
4. Vérifie si Docker est installé → sinon installe **Docker + Compose v2**.
5. Active Docker comme service système.
6. Vérifie les versions installées.
7. Confirme la fin.

👉 Grâce à l’**idempotence**, on peut relancer ce job 100 fois :
si Docker et les dépendances sont déjà là → rien ne casse.

# 📑 4.1 — Installation de `sshpass` sur le runner

## 🎯 Objectif

Cette étape installe l’outil **`sshpass`** dans le **runner GitHub Actions** (la machine éphémère qui exécute le workflow).
👉 C’est une dépendance essentielle car notre pipeline utilise **`rsync`** avec une connexion SSH basée sur **mot de passe** (pas de clé SSH).

---

## 🔹 Étape dans le workflow

```yaml
- name: Install sshpass on runner (for rsync over password SSH)
  run: sudo apt-get update && sudo apt-get install -y sshpass
```

* `apt-get update` → met à jour la liste des paquets.
* `apt-get install -y sshpass` → installe l’outil `sshpass`.

---

## 🔹 Rôle de `sshpass`

Par défaut :

* `ssh` et `rsync` attendent un **mot de passe entré à la main** (mode interactif).
* Dans un workflow automatisé, on ne peut pas taper le mot de passe manuellement.

👉 `sshpass` permet de **fournir un mot de passe à `ssh` ou `rsync` de manière non interactive**, via :

* une variable d’environnement (`SSHPASS=...`)
* ou un fichier texte contenant le mot de passe.

Exemple concret dans notre pipeline :

```bash
sshpass -e rsync -az --delete \
  -e "ssh -p 22 -o StrictHostKeyChecking=no" \
  sentinel/ root@82.165.92.40:/root/sentinel/
```

Ici :

* `sshpass -e` → prend le mot de passe depuis la variable d’environnement `SSHPASS` (sécurisée via GitHub Secrets).
* `rsync` → fait la copie des fichiers **sans jamais demander le mot de passe à l’utilisateur**.

---

## 🔹 Points importants & limites

1. **Sécurité** 🔒

    * L’utilisation de `sshpass` est **moins sécurisée** que les clés SSH, car le mot de passe circule en mémoire.
    * Mais dans notre cas, c’est un compromis simple et rapide.
    * Idéalement → migrer plus tard vers **clé SSH + agent**.

2. **Portabilité** ⚡

    * `sshpass` est disponible sur Linux (installé via APT dans nos runners Ubuntu).
    * Pas nécessaire d’installer manuellement sur le serveur, seulement sur le runner GitHub Actions.

3. **Usage typique**

    * Déploiements automatisés simples (comme le nôtre).
    * Cas où on ne peut pas utiliser de clé SSH (fournisseur ou contraintes).

---

## ✅ En résumé

* `sshpass` permet à `ssh` et `rsync` d’utiliser un mot de passe **sans interaction humaine**.
* On l’installe sur le **runner GitHub Actions**, pas sur le serveur.
* Dans notre pipeline, il est indispensable pour l’étape **rsync** (copie du repo vers `/root/sentinel`).
* C’est pratique pour débuter, mais à terme on migrera vers une **authentification par clé SSH** pour plus de sécurité.

# ğŸ“‘ 4.2 â€” Ensure target dir exists

## ğŸ¯ Objectif

Cette Ã©tape sâ€™assure que le **dossier cible `/root/sentinel` existe sur le serveur** avant que lâ€™on copie les fichiers avec `rsync`.
ğŸ‘‰ Cela Ã©vite des erreurs lors du dÃ©ploiement (par exemple si le dossier nâ€™existe pas aprÃ¨s une rÃ©installation serveur).

---

## ğŸ”¹ Ã‰tape dans le workflow

```yaml
- name: Ensure target dir exists
  uses: appleboy/ssh-action@v1.0.0
  with:
    host: ${{ vars.SSH_HOST }}
    username: ${{ vars.SSH_USER }}
    password: ${{ secrets.SSH_PASSWORD }}
    port: 22
    script: |
      set -e
      mkdir -p /root/sentinel
```

---

## ğŸ”¹ DÃ©composition

* **`uses: appleboy/ssh-action@v1.0.0`**

    * Action GitHub permettant dâ€™exÃ©cuter des commandes **SSH Ã  distance** sur notre serveur.
    * On passe les credentials (`host`, `username`, `password`) depuis nos **vars/secrets GitHub**.

* **`script: |`**
  Bloc de commandes qui seront exÃ©cutÃ©es sur le serveur.

* **`set -e`**

    * Option bash qui fait Ã©chouer immÃ©diatement la tÃ¢che si une commande renvoie une erreur.
    * SÃ©curise le dÃ©ploiement (on Ã©vite de continuer si la crÃ©ation Ã©choue).

* **`mkdir -p /root/sentinel`**

    * CrÃ©e le rÃ©pertoire `/root/sentinel`.
    * Option `-p` :

        * Si le dossier existe dÃ©jÃ  â†’ **aucune erreur**.
        * Sinon â†’ il est crÃ©Ã© automatiquement.
    * Idempotence â†’ cette commande peut Ãªtre exÃ©cutÃ©e 100 fois, rÃ©sultat identique (dossier prÃ©sent).

---

## ğŸ”¹ Pourquoi cette Ã©tape est importante ?

1. **PrÃ©paration avant `rsync`**

    * `rsync` copie les fichiers du repo dans `/root/sentinel/`.
    * Si ce dossier nâ€™existe pas, la commande peut Ã©chouer ou crÃ©er une structure non voulue.

2. **Robustesse du pipeline**

    * Garantit que le dÃ©ploiement marche mÃªme sur un **serveur fraÃ®chement installÃ©**.

3. **CohÃ©rence**

    * Tous les dÃ©ploiements sâ€™appuient sur le mÃªme chemin standard (`/root/sentinel`).
    * Ã‰vite les surprises si quelquâ€™un dÃ©place les fichiers manuellement.

---

## ğŸ”¹ Points intÃ©ressants

* On pourrait choisir un autre rÃ©pertoire (ex. `/srv/sentinel`), mais `/root/sentinel` :
  âœ… simple,
  âœ… cohÃ©rent avec lâ€™accÃ¨s root que nous utilisons,
  âœ… aucune restriction de permissions.

* Cette Ã©tape est **idempotente**, donc sans risque :

    * PremiÃ¨re fois â†’ crÃ©e le dossier.
    * Fois suivantes â†’ ne change rien.

---

## âœ… En rÃ©sumÃ©

* **But :** prÃ©parer le terrain pour `rsync` en sâ€™assurant que `/root/sentinel` existe.
* **Commande clÃ© :** `mkdir -p /root/sentinel`.
* **Avantage :** Ã©vite les erreurs, rend le dÃ©ploiement robuste et reproductible.
* **Bonnes pratiques :** toujours prÃ©voir une Ã©tape "ensure target dir" avant des copies/dÃ©ploiements automatiques.

---
# 📑 4.2 — Ensure target dir exists

## 🎯 Objectif

Cette étape s’assure que le **dossier cible `/root/sentinel` existe sur le serveur** avant que l’on copie les fichiers avec `rsync`.
👉 Cela évite des erreurs lors du déploiement (par exemple si le dossier n’existe pas après une réinstallation serveur).

---

## 🔹 Étape dans le workflow

```yaml
- name: Ensure target dir exists
  uses: appleboy/ssh-action@v1.0.0
  with:
    host: ${{ vars.SSH_HOST }}
    username: ${{ vars.SSH_USER }}
    password: ${{ secrets.SSH_PASSWORD }}
    port: 22
    script: |
      set -e
      mkdir -p /root/sentinel
```

---

## 🔹 Décomposition

* **`uses: appleboy/ssh-action@v1.0.0`**

    * Action GitHub permettant d’exécuter des commandes **SSH à distance** sur notre serveur.
    * On passe les credentials (`host`, `username`, `password`) depuis nos **vars/secrets GitHub**.

* **`script: |`**
  Bloc de commandes qui seront exécutées sur le serveur.

* **`set -e`**

    * Option bash qui fait échouer immédiatement la tâche si une commande renvoie une erreur.
    * Sécurise le déploiement (on évite de continuer si la création échoue).

* **`mkdir -p /root/sentinel`**

    * Crée le répertoire `/root/sentinel`.
    * Option `-p` :

        * Si le dossier existe déjà → **aucune erreur**.
        * Sinon → il est créé automatiquement.
    * Idempotence → cette commande peut être exécutée 100 fois, résultat identique (dossier présent).

---

## 🔹 Pourquoi cette étape est importante ?

1. **Préparation avant `rsync`**

    * `rsync` copie les fichiers du repo dans `/root/sentinel/`.
    * Si ce dossier n’existe pas, la commande peut échouer ou créer une structure non voulue.

2. **Robustesse du pipeline**

    * Garantit que le déploiement marche même sur un **serveur fraîchement installé**.

3. **Cohérence**

    * Tous les déploiements s’appuient sur le même chemin standard (`/root/sentinel`).
    * Évite les surprises si quelqu’un déplace les fichiers manuellement.

---

## 🔹 Points intéressants

* On pourrait choisir un autre répertoire (ex. `/srv/sentinel`), mais `/root/sentinel` :
  ✅ simple,
  ✅ cohérent avec l’accès root que nous utilisons,
  ✅ aucune restriction de permissions.

* Cette étape est **idempotente**, donc sans risque :

    * Première fois → crée le dossier.
    * Fois suivantes → ne change rien.

---

## ✅ En résumé

* **But :** préparer le terrain pour `rsync` en s’assurant que `/root/sentinel` existe.
* **Commande clé :** `mkdir -p /root/sentinel`.
* **Avantage :** évite les erreurs, rend le déploiement robuste et reproductible.
* **Bonnes pratiques :** toujours prévoir une étape "ensure target dir" avant des copies/déploiements automatiques.

---
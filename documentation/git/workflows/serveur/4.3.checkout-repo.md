# 📑 4.3 — Checkout repo

## 🎯 Objectif

Cette étape permet de **récupérer le code source du dépôt GitHub** (le repository Sentinel) dans l’environnement du runner GitHub Actions.
👉 Sans cette étape, le workflow **ne connaît pas le contenu du repo** (donc pas de `docker-compose.yml`, ni de configs, ni de docs à copier sur le serveur).
Documentation : https://github.com/actions/checkout

---

## 🔹 Étape dans le workflow

```yaml
- name: Checkout repo
  uses: actions/checkout@v4
```

---

## 🔹 Décomposition

* **`uses: actions/checkout@v4`**

    * Action officielle maintenue par GitHub.
    * Télécharge automatiquement le **code du dépôt lié au workflow** dans le runner (`ubuntu-latest`).
    * Par défaut → clone la branche sur laquelle le workflow a été déclenché (ex. `main`).

* **Comportement par défaut :**

    * Clone en **profondeur 1** (`--depth=1`) → seul le dernier commit est téléchargé → rapide.
    * Place le repo dans le **dossier de travail** `/home/runner/work/<repo>/<repo>` sur le runner.
    * Si le repo s’appelle `sentinel`, on aura :

      ```
      /home/runner/work/sentinel/sentinel/
      ```

---

## 🔹 Pourquoi est-ce nécessaire ?

1. **Accéder aux fichiers**

    * Tous nos fichiers de config (`docker-compose.yml`, `grafana/`, `prometheus.yml`, etc.) sont dans le repo.
    * Sans `checkout`, le workflow **n’a aucun fichier** → `rsync` échouerait.

2. **Cohérence avec le commit déclencheur**

    * Ce qui est déployé correspond **exactement** au code de la branche (`main`).
    * Pas de décalage entre ce qu’on voit sur GitHub et ce qui tourne sur le serveur.

3. **Compatibilité CI/CD**

    * Presque **tous les workflows GitHub Actions** commencent par `actions/checkout`.
    * C’est la manière standard de travailler sur le code d’un repo.

---

## 🔹 Options utiles

On peut personnaliser `actions/checkout` :

* **`with: fetch-depth: 0`** → clone complet (utile si besoin de l’historique Git).
* **`with: ref: my-branch`** → forcer une branche/commit/tag spécifique.
* **`with: path: ./subdir`** → cloner dans un autre chemin.

Exemple :

```yaml
- name: Checkout repo complet
  uses: actions/checkout@v4
  with:
    fetch-depth: 0
```

---

## 🔹 Points intéressants

* Le **répertoire du repo** est disponible uniquement dans le runner (temporaire).
* On doit donc utiliser `rsync` pour **copier les fichiers sur le serveur** si on veut les persister.
* Les runners GitHub sont détruits après chaque exécution → pas de persistance locale.

---

## ✅ En résumé

* **But :** rendre accessible le contenu du repo dans le workflow.
* **Action clé :** `actions/checkout@v4`.
* **Pourquoi :** sans ça, pas de fichiers à déployer.
* **Résultat :** le code du repo est disponible dans `/home/runner/work/...`.
* **Bonnes pratiques :** presque indispensable dans tout workflow CI/CD.

# ğŸ“‘ 4.4 â€” Rsync du dossier `sentinel/` vers `/root/sentinel/`

## ğŸ¯ Objectif

Cette Ã©tape sert Ã  **synchroniser le contenu du dossier `sentinel/` du repo GitHub** vers le rÃ©pertoire `/root/sentinel/` du serveur Sentinel.

ğŸ‘‰ Cela garantit que la configuration en production correspond **exactement** Ã  celle versionnÃ©e dans GitHub.

---

## ğŸ”¹ Ã‰tape dans le workflow

```yaml
- name: Rsync repo/sentinel -> server:/root/sentinel (with delete)
  env:
    SSHPASS: ${{ secrets.SSH_PASSWORD }}
  run: |
    test -d sentinel || { echo "Le dossier 'sentinel/' n'existe pas dans le repo"; exit 1; }
    sshpass -e rsync -az --delete \
      -e "ssh -p 22 -o StrictHostKeyChecking=no" \
      sentinel/ ${{ vars.SSH_USER }}@${{ vars.SSH_HOST }}:/root/sentinel/
```

---

## ğŸ”¹ DÃ©composition

1. **`test -d sentinel ...`**

    * VÃ©rifie que le dossier `sentinel/` existe dans le repo clonÃ© par `actions/checkout`.
    * Si absent â†’ stoppe le workflow (`exit 1`) pour Ã©viter dâ€™Ã©craser le serveur avec un dossier vide.

2. **`sshpass -e rsync ...`**

    * **`sshpass`** injecte le mot de passe stockÃ© dans `secrets.SSH_PASSWORD` (via `-e` â†’ lit depuis la variable dâ€™env).
    * **`rsync`** copie et synchronise les fichiers **via SSH**.

   ParamÃ¨tres clÃ©s :

    * `-a` â†’ archive mode (prÃ©serve droits, dates, liens symboliques, etc.).
    * `-z` â†’ compression (plus rapide sur rÃ©seau).
    * `--delete` â†’ supprime du serveur les fichiers absents dans le repo (synchronisation stricte). (checker pour garder finalement les elements auto generÃ© ...)
    * `-e "ssh -p 22 -o StrictHostKeyChecking=no"` â†’ utilise SSH sur port 22, dÃ©sactive la vÃ©rification stricte de clÃ© (utile en CI, mais moins secure).

   ConcrÃ¨tement, Ã§a fait :

   ```
   local: sentinel/   -->   serveur:/root/sentinel/
   ```

3. **`sentinel/` (local)**

    * Le dossier contenant `docker-compose.yml`, `grafana/`, `prometheus.yml` etc.
    * Mis Ã  jour Ã  chaque `git push`.

4. **`/root/sentinel/` (serveur)**

    * Câ€™est la **source de vÃ©ritÃ©** pour Docker Compose sur le serveur.
    * Toujours reflÃ¨te lâ€™Ã©tat exact du repo aprÃ¨s cette Ã©tape.

---

## ğŸ”¹ Pourquoi câ€™est important ?

* **Versioning = Prod**

    * Tout changement validÃ© dans GitHub est automatiquement appliquÃ© en prod.
* **Synchronisation stricte**

    * Avec `--delete`, pas de â€œfichiers fantÃ´mesâ€ qui trainent sur le serveur.
    * Si tu supprimes un dashboard du repo, il sera aussi supprimÃ© du serveur.
* **Automatisation complÃ¨te**

    * Plus besoin de se connecter en SSH et copier manuellement des fichiers.

---

## ğŸ”¹ Points intÃ©ressants Ã  savoir

* **SÃ©curitÃ©**

    * `sshpass` simplifie, mais câ€™est moins sÃ©curisÃ© quâ€™une clÃ© SSH. (https://www.redhat.com/fr/blog/ssh-automation-sshpass)
    * Bonnes pratiques : migrer plus tard vers clÃ© SSH + `known_hosts` validÃ©.

* **AtomicitÃ©**

    * `rsync` copie uniquement les fichiers modifiÃ©s â†’ plus rapide que `scp -r` qui recopie tout. (https://doc.ubuntu-fr.org/rsync)

* **Attention au `--delete`**

    * Si jamais ton repo est vide (bug ou erreur), `rsync` va aussi vider `/root/sentinel/`.
    * Dâ€™oÃ¹ la protection `test -d sentinel || exit 1`.

* **Rollback**

    * Si un commit casse la config, il suffit de rollbacker Git â†’ `rsync` remet lâ€™Ã©tat prÃ©cÃ©dent.

---

## âœ… En rÃ©sumÃ©

* **But :** copier les configs de GitHub â†’ serveur (`/root/sentinel/`).
* **Comment :** via `rsync` sur SSH, automatisÃ© avec `sshpass`.
* **Avantages :** synchro stricte, rapide, fiable, reproductible.
* **Limite :** dÃ©pend dâ€™un mot de passe en secret GitHub (clÃ© SSH serait plus secure).

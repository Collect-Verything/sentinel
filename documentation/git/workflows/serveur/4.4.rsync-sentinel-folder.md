# 📑 4.4 — Rsync du dossier `sentinel/` vers `/root/sentinel/`

## 🎯 Objectif

Cette étape sert à **synchroniser le contenu du dossier `sentinel/` du repo GitHub** vers le répertoire `/root/sentinel/` du serveur Sentinel.

👉 Cela garantit que la configuration en production correspond **exactement** à celle versionnée dans GitHub.

---

## 🔹 Étape dans le workflow

```yaml
- name: Rsync repo/sentinel -> server:/root/sentinel (with delete)
  env:
    SSHPASS: ${{ secrets.SSH_PASSWORD }}
  run: |
    test -d sentinel || { echo "Le dossier 'sentinel/' n'existe pas dans le repo"; exit 1; }
    sshpass -e rsync -az --delete \
      -e "ssh -p 22 -o StrictHostKeyChecking=no" \
      sentinel/ ${{ vars.SSH_USER }}@${{ vars.SSH_HOST }}:/root/sentinel/
```

---

## 🔹 Décomposition

1. **`test -d sentinel ...`**

    * Vérifie que le dossier `sentinel/` existe dans le repo cloné par `actions/checkout`.
    * Si absent → stoppe le workflow (`exit 1`) pour éviter d’écraser le serveur avec un dossier vide.

2. **`sshpass -e rsync ...`**

    * **`sshpass`** injecte le mot de passe stocké dans `secrets.SSH_PASSWORD` (via `-e` → lit depuis la variable d’env).
    * **`rsync`** copie et synchronise les fichiers **via SSH**.

   Paramètres clés :

    * `-a` → archive mode (préserve droits, dates, liens symboliques, etc.).
    * `-z` → compression (plus rapide sur réseau).
    * `--delete` → supprime du serveur les fichiers absents dans le repo (synchronisation stricte). (checker pour garder finalement les elements auto generé ...)
    * `-e "ssh -p 22 -o StrictHostKeyChecking=no"` → utilise SSH sur port 22, désactive la vérification stricte de clé (utile en CI, mais moins secure).

   Concrètement, ça fait :

   ```
   local: sentinel/   -->   serveur:/root/sentinel/
   ```

3. **`sentinel/` (local)**

    * Le dossier contenant `docker-compose.yml`, `grafana/`, `prometheus.yml` etc.
    * Mis à jour à chaque `git push`.

4. **`/root/sentinel/` (serveur)**

    * C’est la **source de vérité** pour Docker Compose sur le serveur.
    * Toujours reflète l’état exact du repo après cette étape.

---

## 🔹 Pourquoi c’est important ?

* **Versioning = Prod**

    * Tout changement validé dans GitHub est automatiquement appliqué en prod.
* **Synchronisation stricte**

    * Avec `--delete`, pas de “fichiers fantômes” qui trainent sur le serveur.
    * Si tu supprimes un dashboard du repo, il sera aussi supprimé du serveur.
* **Automatisation complète**

    * Plus besoin de se connecter en SSH et copier manuellement des fichiers.

---

## 🔹 Points intéressants à savoir

* **Sécurité**

    * `sshpass` simplifie, mais c’est moins sécurisé qu’une clé SSH. (https://www.redhat.com/fr/blog/ssh-automation-sshpass)
    * Bonnes pratiques : migrer plus tard vers clé SSH + `known_hosts` validé.

* **Atomicité**

    * `rsync` copie uniquement les fichiers modifiés → plus rapide que `scp -r` qui recopie tout. (https://doc.ubuntu-fr.org/rsync)

* **Attention au `--delete`**

    * Si jamais ton repo est vide (bug ou erreur), `rsync` va aussi vider `/root/sentinel/`.
    * D’où la protection `test -d sentinel || exit 1`.

* **Rollback**

    * Si un commit casse la config, il suffit de rollbacker Git → `rsync` remet l’état précédent.

---

## ✅ En résumé

* **But :** copier les configs de GitHub → serveur (`/root/sentinel/`).
* **Comment :** via `rsync` sur SSH, automatisé avec `sshpass`.
* **Avantages :** synchro stricte, rapide, fiable, reproductible.
* **Limite :** dépend d’un mot de passe en secret GitHub (clé SSH serait plus secure).

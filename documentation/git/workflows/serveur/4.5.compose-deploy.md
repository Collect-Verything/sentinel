# ğŸ“‘ 4.5 â€” Compose deploy

Cette Ã©tape exÃ©cute le **dÃ©ploiement rÃ©el** de la stack depuis le serveur (dans `/root/sentinel`).
Elle **valide** la configuration, **met Ã  jour** les images, **remplace** proprement lâ€™ancienne stack et **relance** les services.

---

## ğŸ”¹ Le step dans le workflow

```yaml
# ğŸš€ DÃ©ploiement depuis /root/sentinel
- name: Compose deploy
  uses: appleboy/ssh-action@v1.0.0
  with:
    host: ${{ vars.SSH_HOST }}
    username: ${{ vars.SSH_USER }}
    password: ${{ secrets.SSH_PASSWORD }}
    port: 22
    script: |
      set -euo pipefail
      cd /root/sentinel

      echo "==> Validation de la config"
      docker compose config >/dev/null

      echo "==> Pull des images (si :latest)"
      docker compose pull || true

      echo "==> Down ancienne stack"
      docker compose down --remove-orphans || true

      echo "==> Up nouvelle stack"
      docker compose up -d

      echo "==> Etat"
      docker compose ps
```

---

## ğŸ” DÃ©composition ligne par ligne

### SÃ©curisation & contexte

* `set -euo pipefail`

    * `-e` : stoppe Ã  la premiÃ¨re erreur
    * `-u` : interdit dâ€™utiliser une variable non dÃ©finie
    * `pipefail` : toute erreur dans un pipe fait Ã©chouer la commande
      ğŸ‘‰ Ã‰vite les dÃ©ploiements â€œÃ  moitiÃ©â€.

* `cd /root/sentinel`
  On se place **dans le dossier qui contient** `docker-compose.yml`.
  ğŸ‘‰ Sans Ã§a, `docker compose` ne trouverait pas la stack.

---

### 1) Validation statique

```bash
docker compose config >/dev/null
```

* **Fusionne** tous les fichiers Compose, rÃ©sout les variables, vÃ©rifie la **syntaxe**.
* Ã‰choue immÃ©diatement en cas dâ€™erreur (clÃ© inconnue, indentation, var manquanteâ€¦).
* RedirigÃ© vers `/dev/null` car on veut juste le **code de retour**.
  ğŸ‘‰ Câ€™est le **pare-feu** qui empÃªche de dÃ©ployer une config cassÃ©e.

---

### 2) Mise Ã  jour des images

```bash
docker compose pull || true
```

* TÃ©lÃ©charge les **nouvelles versions** des images rÃ©fÃ©rencÃ©es (utile si tu utilises `:latest`).
* `|| true` : ne bloque pas le dÃ©ploiement si un pull Ã©choue (ex. pas de rÃ©seau, tag dÃ©jÃ  Ã  jour).
  ğŸ‘‰ Bonne pratique si tu veux rester Ã  jour **sans** rebuilder.

> ğŸ’¡ Conseil : en prod, prÃ©fÃ¨re **des tags versionnÃ©s** (`grafana:12.1.1`) plutÃ´t que `latest`, pour des dÃ©ploiements **reproductibles**.

---

### 3) ArrÃªt propre & nettoyage

```bash
docker compose down --remove-orphans || true
```

* **Stoppe** et **supprime** les conteneurs de la stack actuelle.
* `--remove-orphans` nettoie les services **qui nâ€™existent plus** dans le compose (Ã©vite les â€œfantÃ´mesâ€).
* Ne supprime **pas** les volumes nommÃ©s par dÃ©faut â†’ **donnÃ©es persistantes** conservÃ©es (Grafana DB, Loki WALâ€¦).
* `|| true` : ne casse pas le job si rien nâ€™Ã©tait lancÃ©.
  ğŸ‘‰ Repart sur une base **propre** avant de (re)monter.

> ğŸ” Remarque : `down` supprime aussi les **rÃ©seaux** de la stack ; ils seront recrÃ©Ã©s au `up`.

---

### 4) Relance (dÃ©ploiement)

```bash
docker compose up -d
```

* (Re)crÃ©e et lance les services **en dÃ©tachÃ©**.
* RecrÃ©e **uniquement** ce qui a changÃ© (image, env, volumes, mounts, cmdâ€¦).
* Respecte `restart: unless-stopped` si dÃ©fini.
  ğŸ‘‰ Câ€™est lâ€™Ã©tape qui **applique** le nouvel Ã©tat.

> ğŸ§  Astuce : `docker compose up -d --force-recreate` pour forcer la recrÃ©ation,
> ou `--pull always` (Compose v2.23+) pour tirer systÃ©matiquement les images.

---

### 5) Ã‰tat post-dÃ©ploiement

```bash
docker compose ps
```

* Affiche un **rÃ©sumÃ©** : noms, ports exposÃ©s, statut, politique de redÃ©marrage.
  ğŸ‘‰ VÃ©rif visuelle rapide que tout est **UP**.

---

## ğŸ§  Idempotence & ce que **Ã§a ne fait pas**

* **Idempotent** : relancer cette Ã©tape remet la stack **dans lâ€™Ã©tat dÃ©crit** par ton repo.
* **Ne supprime pas** les volumes nommÃ©s â†’ les donnÃ©es (ex. Grafana) **restent**.
* **Ne build pas** dâ€™images locales (on nâ€™utilise pas `build:` ici). Si tu en ajoutes, il faudra `docker compose build`.

---

## ğŸ§ª Diagnostic rapide (si souci)

* Voir les logs dâ€™un service :

  ```bash
  docker compose logs -n 200 grafana
  docker compose logs -f loki
  ```
* Voir la config effective (trÃ¨s utile !) :

  ```bash
  docker compose config
  ```
* VÃ©rifier volumes & rÃ©seaux :

  ```bash
  docker volume ls
  docker network ls
  ```
* Tester la santÃ© applicative :

  ```bash
  curl -sf http://localhost:9090/-/ready && echo OK
  curl -sf http://localhost:3100/ready && echo OK
  curl -sf http://localhost:3000/login && echo OK
  ```

---

## âš ï¸ PiÃ¨ges frÃ©quents & bonnes pratiques

* **Orphans non retirÃ©s** â†’ garde `--remove-orphans` pour nettoyer les services retirÃ©s du compose.
* **Tags `latest`** â†’ imprÃ©visibles. PrÃ©fÃ¨re des **versions pinÃ©es** en prod.
* **Provisioning Grafana** â†’ si tu changes les YAML mais Grafana â€œgarde lâ€™ancienâ€ (DB), pense aux options `delete*` dans tes fichiers de provisioning.
* **Secrets/env** â†’ injecte via **Secrets GitHub** (pas en clair dans le compose).
* **Ordre de dÃ©pendances** â†’ `depends_on` aide Ã  lâ€™ordre, mais **nâ€™attend pas** que le service soit â€œreadyâ€. Pour Ã§a, utilise **healthchecks** et des retries cÃ´tÃ© client.

---

## âœ… TL;DR

* **`config`** : stoppe net si la config Compose est invalide.
* **`pull`** : met Ã  jour les images (utile pour `latest`).
* **`down --remove-orphans`** : nettoie proprement lâ€™ancienne stack.
* **`up -d`** : (re)lance la nouvelle.
* **`ps`** : contrÃ´le final.

Câ€™est le **cÅ“ur du dÃ©ploiement** : simple, sÃ»r, et **rejouable** Ã  lâ€™infini.

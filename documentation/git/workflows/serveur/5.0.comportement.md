# 📑 5.0 — Comportement attendu du workflow Sentinel

Une fois le workflow **`deploy-sentinel-monitoring.yml`** en place, voici ce qui doit se produire **de manière systématique et fiable** :

---

## 🔄 Déclenchement automatique

* **Condition de déclenchement** :

    * À chaque **push sur la branche `main`**
    * Si et seulement si un fichier du répertoire `sentinel/` ou du workflow lui-même (`.github/workflows/deploy-sentinel-monitoring.yml`) a été modifié.

👉 Cela garantit que **seules les modifications pertinentes** (configs Prometheus, Grafana, Loki, Fluent Bit, etc.) provoquent un déploiement.

---

## 📂 Synchronisation des fichiers

* Le contenu du dossier `sentinel/` du repo est **copié** (via `rsync --delete`) vers `/root/sentinel/` sur le serveur Sentinel.
* Les anciens fichiers supprimés du repo sont également supprimés côté serveur.

👉 Résultat : le serveur est **toujours aligné** avec l’état du repo GitHub → **Git = vérité absolue**.

---

## 🐳 Déploiement Docker Compose

* Depuis `/root/sentinel`, le workflow exécute :

    1. `docker compose config` → validation syntaxe
    2. `docker compose pull` → récupère les dernières images (utile pour les tags `:latest`)
    3. `docker compose down --remove-orphans` → arrête l’ancienne stack
    4. `docker compose up -d` → démarre la nouvelle stack en arrière-plan
    5. `docker compose ps` → affiche l’état final des conteneurs

👉 Cela permet un **rolling update** simple et sans intervention manuelle.

---

## 📊 Provisioning Grafana

* Grafana recharge automatiquement ses configurations depuis `/etc/grafana/provisioning/` (monté depuis `/root/sentinel/grafana/provisioning/`).
* Les éléments concernés :

    * **Datasources** (`datasource.yml`)
    * **Dashboards** (`dashboard.yml` + JSONs)
    * **Alerting** (règles, contact points, policies)

👉 Toute modification d’un fichier de provisioning dans Git est appliquée **au prochain restart** de Grafana → pas besoin de cliquer dans l’UI.

---

## ✅ Vérifications automatiques

* Une fois le déploiement terminé, des **healthchecks** confirment que :

    * Prometheus est prêt (`/-/ready`)
    * Loki répond (`/ready`)
    * Grafana tourne (`/login`)

👉 Si un service est KO → le workflow échoue → tu es alerté directement sur GitHub.

---

## 🔐 Gestion des secrets

* Les variables sensibles (mot de passe SMTP Grafana, SSH password/clé, etc.) ne sont **jamais dans le repo**.
* Elles sont injectées à l’exécution via **GitHub Secrets** et **Variables**.

👉 Sécurité respectée tout en gardant un déploiement reproductible.

---

## 🧠 En résumé

* Chaque commit sur `main` impactant `sentinel/` = **nouvelle version déployée**.
* Le serveur est toujours **en miroir** avec GitHub.
* Les dashboards, datasources et alertes Grafana sont **auto-provisionnés**.
* Un contrôle qualité rapide (healthchecks) évite de laisser tourner un monitoring cassé.

⚡ Bref : la stack Sentinel devient **“GitOps-ready”** → tu modifies dans ton IDE, tu pushes, et le monitoring se met à jour tout seul.

# ğŸ“‘ 5.0 â€” Comportement attendu du workflow Sentinel

Une fois le workflow **`deploy-sentinel-monitoring.yml`** en place, voici ce qui doit se produire **de maniÃ¨re systÃ©matique et fiable** :

---

## ğŸ”„ DÃ©clenchement automatique

* **Condition de dÃ©clenchement** :

    * Ã€ chaque **push sur la branche `main`**
    * Si et seulement si un fichier du rÃ©pertoire `sentinel/` ou du workflow lui-mÃªme (`.github/workflows/deploy-sentinel-monitoring.yml`) a Ã©tÃ© modifiÃ©.

ğŸ‘‰ Cela garantit que **seules les modifications pertinentes** (configs Prometheus, Grafana, Loki, Fluent Bit, etc.) provoquent un dÃ©ploiement.

---

## ğŸ“‚ Synchronisation des fichiers

* Le contenu du dossier `sentinel/` du repo est **copiÃ©** (via `rsync --delete`) vers `/root/sentinel/` sur le serveur Sentinel.
* Les anciens fichiers supprimÃ©s du repo sont Ã©galement supprimÃ©s cÃ´tÃ© serveur.

ğŸ‘‰ RÃ©sultat : le serveur est **toujours alignÃ©** avec lâ€™Ã©tat du repo GitHub â†’ **Git = vÃ©ritÃ© absolue**.

---

## ğŸ³ DÃ©ploiement Docker Compose

* Depuis `/root/sentinel`, le workflow exÃ©cute :

    1. `docker compose config` â†’ validation syntaxe
    2. `docker compose pull` â†’ rÃ©cupÃ¨re les derniÃ¨res images (utile pour les tags `:latest`)
    3. `docker compose down --remove-orphans` â†’ arrÃªte lâ€™ancienne stack
    4. `docker compose up -d` â†’ dÃ©marre la nouvelle stack en arriÃ¨re-plan
    5. `docker compose ps` â†’ affiche lâ€™Ã©tat final des conteneurs

ğŸ‘‰ Cela permet un **rolling update** simple et sans intervention manuelle.

---

## ğŸ“Š Provisioning Grafana

* Grafana recharge automatiquement ses configurations depuis `/etc/grafana/provisioning/` (montÃ© depuis `/root/sentinel/grafana/provisioning/`).
* Les Ã©lÃ©ments concernÃ©s :

    * **Datasources** (`datasource.yml`)
    * **Dashboards** (`dashboard.yml` + JSONs)
    * **Alerting** (rÃ¨gles, contact points, policies)

ğŸ‘‰ Toute modification dâ€™un fichier de provisioning dans Git est appliquÃ©e **au prochain restart** de Grafana â†’ pas besoin de cliquer dans lâ€™UI.

---

## âœ… VÃ©rifications automatiques

* Une fois le dÃ©ploiement terminÃ©, des **healthchecks** confirment que :

    * Prometheus est prÃªt (`/-/ready`)
    * Loki rÃ©pond (`/ready`)
    * Grafana tourne (`/login`)

ğŸ‘‰ Si un service est KO â†’ le workflow Ã©choue â†’ tu es alertÃ© directement sur GitHub.

---

## ğŸ” Gestion des secrets

* Les variables sensibles (mot de passe SMTP Grafana, SSH password/clÃ©, etc.) ne sont **jamais dans le repo**.
* Elles sont injectÃ©es Ã  lâ€™exÃ©cution via **GitHub Secrets** et **Variables**.

ğŸ‘‰ SÃ©curitÃ© respectÃ©e tout en gardant un dÃ©ploiement reproductible.

---

## ğŸ§  En rÃ©sumÃ©

* Chaque commit sur `main` impactant `sentinel/` = **nouvelle version dÃ©ployÃ©e**.
* Le serveur est toujours **en miroir** avec GitHub.
* Les dashboards, datasources et alertes Grafana sont **auto-provisionnÃ©s**.
* Un contrÃ´le qualitÃ© rapide (healthchecks) Ã©vite de laisser tourner un monitoring cassÃ©.

âš¡ Bref : la stack Sentinel devient **â€œGitOps-readyâ€** â†’ tu modifies dans ton IDE, tu pushes, et le monitoring se met Ã  jour tout seul.

# ğŸ“‘ 5.1 â€” Cas limites & erreurs frÃ©quentes dans le workflow Sentinel

MÃªme si le workflow **`deploy-sentinel-monitoring.yml`** est robuste, certaines situations peuvent poser problÃ¨me. Voici une fiche dÃ©taillÃ©e pour les identifier, les comprendre et les Ã©viter.

---

## ğŸ—„ï¸ 1. Provisioning Grafana dÃ©jÃ  en base de donnÃ©es

### ğŸ” Le problÃ¨me

Grafana stocke ses datasources, dashboards et rÃ¨gles dâ€™alertes **dans sa base SQLite interne** (ou Postgres/MySQL si configurÃ©).
ğŸ‘‰ Si un Ã©lÃ©ment a dÃ©jÃ  Ã©tÃ© crÃ©Ã© manuellement dans lâ€™UI, il peut **coexister ou entrer en conflit** avec ce qui est fourni via les fichiers `provisioning/`.

### âš ï¸ SymptÃ´mes

* Des dashboards apparaissent en double.
* Des modifications faites dans lâ€™UI sont Ã©crasÃ©es au redÃ©ploiement.
* Certaines rÃ¨gles dâ€™alerte ne se mettent pas Ã  jour.

### ğŸ’¡ Solutions

* DÃ©cider dâ€™une politique claire :

    * **Git = vÃ©ritÃ© absolue** â†’ ne rien modifier dans lâ€™UI.
    * OU accepter un mix UI + provisioning â†’ mais risque dâ€™incohÃ©rence.
* VÃ©rifier rÃ©guliÃ¨rement avec `docker exec -it grafana sqlite3 /var/lib/grafana/grafana.db` ce qui est stockÃ© en base.
* Documenter : "Toute modif doit passer par le repo".

---

## ğŸ”‘ 2. Secrets mal configurÃ©s

### ğŸ” Le problÃ¨me

Les secrets (`GF_SMTP_PASSWORD`, `SSH_PASSWORD`, etc.) sont stockÃ©s dans **GitHub Secrets**.
ğŸ‘‰ Une faute de frappe ou un oubli peut bloquer le dÃ©ploiement.

### âš ï¸ SymptÃ´mes

* `sshpass: Permission denied` â†’ mauvais mot de passe SSH.
* `SMTP authentication failed` â†’ mauvais mot de passe Gmail.
* Erreurs `undefined variable` â†’ variable manquante.

### ğŸ’¡ Solutions

* VÃ©rifier que chaque secret est bien dÃ©fini dans `Settings > Secrets and variables > Actions`.
* Distinguer clairement :

    * `secrets.` â†’ sensible (jamais visible)
    * `vars.` â†’ non-sensible (visible dans lâ€™UI GitHub)
* Faire un test manuel (`ssh root@host`, test SMTP avec telnet) avant de lancer le workflow.

---

## ğŸ“‚ 3. Volumes persistants non versionnÃ©s

### ğŸ” Le problÃ¨me

Certains services (Grafana, Prometheus, Loki) utilisent des **volumes Docker persistants** pour stocker leurs donnÃ©es.
ğŸ‘‰ Ces donnÃ©es ne sont pas Ã©crites dans Git â†’ un `docker compose down -v` les supprime dÃ©finitivement.

### âš ï¸ SymptÃ´mes

* Dashboards ou rÃ¨gles Grafana â€œdisparaissentâ€ aprÃ¨s un redeploy.
* Prometheus perd son historique de mÃ©triques.
* Loki perd ses logs anciens.

### ğŸ’¡ Solutions

* Bien distinguer :

    * **Config = versionnÃ©e** (dans Git).
    * **Data = persistante** (volumes Docker).
* Ne jamais utiliser `docker compose down -v` sauf si volontaire.
* Si besoin de backup :

  ```bash
  docker run --rm -v grafana-storage:/data -v $(pwd):/backup busybox tar czf /backup/grafana-backup.tar.gz /data
  ```

---

## ğŸ³ 4. Erreurs Docker Compose

### ğŸ” Le problÃ¨me

Si le `docker-compose.yml` contient une erreur de syntaxe ou une config invalide, le dÃ©ploiement Ã©choue.

### âš ï¸ SymptÃ´mes

* `docker compose config` retourne une erreur.
* Le workflow GitHub Ã©choue dÃ¨s la phase **Compose deploy**.

### ğŸ’¡ Solutions

* Toujours valider localement avant de commit :

  ```bash
  docker compose -f sentinel/docker-compose.yml config
  ```
* Ajouter un job de lint YAML dans le pipeline pour Ã©viter les fautes dâ€™indentation.


### ğŸ“Œ Note spÃ©ciale sur Docker Compose v2

Nous avons rencontrÃ© un souci liÃ© Ã  la **coexistence de `docker-compose` (v1, binaire sÃ©parÃ©)** et **`docker compose` (v2, intÃ©grÃ© au CLI Docker)**.

* Avec Compose v1, certaines fonctionnalitÃ©s modernes (plugins, `profiles`, intÃ©gration native) nâ€™Ã©taient pas supportÃ©es.
* Sur certains serveurs Ubuntu, lâ€™installation par dÃ©faut amenait encore `docker-compose v1`, ce qui provoquait des erreurs lors de lâ€™exÃ©cution dans le workflow.
* La solution a Ã©tÃ© de forcer lâ€™installation de **Docker Compose v2 via le paquet officiel Docker** :

  ```bash
  apt-get install -y docker-compose-plugin
  ```

ğŸ‘‰ DÃ©sormais, nous utilisons **`docker compose` (sans tiret)** partout, ce qui Ã©vite les ambiguÃ¯tÃ©s et garantit la compatibilitÃ© avec les workflows modernes.

ğŸ”— **Documentation officielle**

* Docker : [Overview of Docker Compose](https://docs.docker.com/compose/)
* Docker : [Migrate to Compose V2](https://docs.docker.com/compose/migrate/)
* Docker GitHub : [docker/compose](https://github.com/docker/compose) (repo historique de v1, archivÃ© en grande partie)
* Docker GitHub : [compose-cli](https://github.com/docker/compose-cli) (plugin officiel v2)

---

ğŸ”— **Articles de rÃ©fÃ©rence**

* Docker Blog : [Docker Compose V2 General Availability](https://www.docker.com/blog/announcing-compose-v2-general-availability/)
* Dev.to : [Docker Compose V1 vs V2: Whatâ€™s New and How to Upgrade](https://dev.to/azure/docker-compose-v1-vs-v2-whats-new-and-how-to-upgrade-4k38)
* Medium : [Migrating from docker-compose (v1) to Docker Compose v2](https://medium.com/geekculture/migrating-from-docker-compose-v1-to-docker-compose-v2-195ba5fbc396)

---

## ğŸŒ 5. Services qui ne rÃ©pondent pas aux healthchecks

### ğŸ” Le problÃ¨me

Les healthchecks se basent sur des endpoints simples (`/-/ready`, `/ready`, `/login`).
ğŸ‘‰ Si le service met plus de temps que prÃ©vu Ã  dÃ©marrer, lâ€™action Ã©choue.

### âš ï¸ SymptÃ´mes

* Workflow rouge alors que les services finissent par Ãªtre disponibles.
* `curl: (7) Failed to connect` ou `connection refused`.

### ğŸ’¡ Solutions

* Ajouter un retry avec dÃ©lai (exemple : 3 tentatives avec `sleep 5`).
* Adapter les checks si besoin (Grafana â†’ `/api/health`).

---

## ğŸš¨ 6. Conflit avec des services manuels

### ğŸ” Le problÃ¨me

Si quelquâ€™un lance manuellement `docker run` ou modifie des configs directement sur le serveur, le workflow peut casser ces changements.

### âš ï¸ SymptÃ´mes

* Conteneurs â€œorphelinsâ€ arrÃªtÃ©s automatiquement (`docker compose down --remove-orphans`).
* Configs locales Ã©crasÃ©es par `rsync --delete`.

### ğŸ’¡ Solutions

* DÃ©finir une rÃ¨gle : **ne rien modifier en direct sur le serveur**.
* Si besoin de tests â†’ travailler dans une branche GitHub et dÃ©ployer sur un serveur de staging.

---

## ğŸ” 7. SÃ©curitÃ© SSH

### ğŸ” Le problÃ¨me

Lâ€™utilisation du compte `root` + mot de passe dans GitHub Actions est pratique mais risquÃ©e.

### âš ï¸ SymptÃ´mes

* Tentatives de brute force dans `auth.log`.
* Fail2ban qui bloque lâ€™IP du runner GitHub.

### ğŸ’¡ Solutions

* CrÃ©er un utilisateur `deploy` dÃ©diÃ© avec `sudo` restreint.
* Passer Ã  **SSH par clÃ© privÃ©e** plutÃ´t que mot de passe.
* Changer le port SSH et activer `fail2ban`.

---

## ğŸ§  En rÃ©sumÃ©

Les erreurs frÃ©quentes concernent :

1. **Grafana provisioning** â†’ conflits avec la DB interne.
2. **Secrets mal configurÃ©s** â†’ workflow Ã©choue.
3. **Volumes persistants** â†’ perte de donnÃ©es si mal gÃ©rÃ©s.
4. **Erreurs Docker Compose** â†’ dÃ©ploiement bloquÃ©.
5. **Services lents** â†’ healthchecks Ã©chouent trop vite.
6. **Conflits serveur** â†’ GitHub Actions Ã©crase les configs locales.
7. **SÃ©curitÃ© SSH** â†’ root + password = provisoire seulement.

ğŸ‘‰ Lâ€™approche idÃ©ale : **GitOps strict** (Git = vÃ©ritÃ© absolue), secrets bien gÃ©rÃ©s, volumes protÃ©gÃ©s, et serveur â€œstatelessâ€ (toute modif repassera par Git).

# 📑 5.1 — Cas limites & erreurs fréquentes dans le workflow Sentinel

Même si le workflow **`deploy-sentinel-monitoring.yml`** est robuste, certaines situations peuvent poser problème. Voici une fiche détaillée pour les identifier, les comprendre et les éviter.

---

## 🗄️ 1. Provisioning Grafana déjà en base de données

### 🔍 Le problème

Grafana stocke ses datasources, dashboards et règles d’alertes **dans sa base SQLite interne** (ou Postgres/MySQL si configuré).
👉 Si un élément a déjà été créé manuellement dans l’UI, il peut **coexister ou entrer en conflit** avec ce qui est fourni via les fichiers `provisioning/`.

### ⚠️ Symptômes

* Des dashboards apparaissent en double.
* Des modifications faites dans l’UI sont écrasées au redéploiement.
* Certaines règles d’alerte ne se mettent pas à jour.

### 💡 Solutions

* Décider d’une politique claire :

    * **Git = vérité absolue** → ne rien modifier dans l’UI.
    * OU accepter un mix UI + provisioning → mais risque d’incohérence.
* Vérifier régulièrement avec `docker exec -it grafana sqlite3 /var/lib/grafana/grafana.db` ce qui est stocké en base.
* Documenter : "Toute modif doit passer par le repo".

---

## 🔑 2. Secrets mal configurés

### 🔍 Le problème

Les secrets (`GF_SMTP_PASSWORD`, `SSH_PASSWORD`, etc.) sont stockés dans **GitHub Secrets**.
👉 Une faute de frappe ou un oubli peut bloquer le déploiement.

### ⚠️ Symptômes

* `sshpass: Permission denied` → mauvais mot de passe SSH.
* `SMTP authentication failed` → mauvais mot de passe Gmail.
* Erreurs `undefined variable` → variable manquante.

### 💡 Solutions

* Vérifier que chaque secret est bien défini dans `Settings > Secrets and variables > Actions`.
* Distinguer clairement :

    * `secrets.` → sensible (jamais visible)
    * `vars.` → non-sensible (visible dans l’UI GitHub)
* Faire un test manuel (`ssh root@host`, test SMTP avec telnet) avant de lancer le workflow.

---

## 📂 3. Volumes persistants non versionnés

### 🔍 Le problème

Certains services (Grafana, Prometheus, Loki) utilisent des **volumes Docker persistants** pour stocker leurs données.
👉 Ces données ne sont pas écrites dans Git → un `docker compose down -v` les supprime définitivement.

### ⚠️ Symptômes

* Dashboards ou règles Grafana “disparaissent” après un redeploy.
* Prometheus perd son historique de métriques.
* Loki perd ses logs anciens.

### 💡 Solutions

* Bien distinguer :

    * **Config = versionnée** (dans Git).
    * **Data = persistante** (volumes Docker).
* Ne jamais utiliser `docker compose down -v` sauf si volontaire.
* Si besoin de backup :

  ```bash
  docker run --rm -v grafana-storage:/data -v $(pwd):/backup busybox tar czf /backup/grafana-backup.tar.gz /data
  ```

---

## 🐳 4. Erreurs Docker Compose

### 🔍 Le problème

Si le `docker-compose.yml` contient une erreur de syntaxe ou une config invalide, le déploiement échoue.

### ⚠️ Symptômes

* `docker compose config` retourne une erreur.
* Le workflow GitHub échoue dès la phase **Compose deploy**.

### 💡 Solutions

* Toujours valider localement avant de commit :

  ```bash
  docker compose -f sentinel/docker-compose.yml config
  ```
* Ajouter un job de lint YAML dans le pipeline pour éviter les fautes d’indentation.


### 📌 Note spéciale sur Docker Compose v2

Nous avons rencontré un souci lié à la **coexistence de `docker-compose` (v1, binaire séparé)** et **`docker compose` (v2, intégré au CLI Docker)**.

* Avec Compose v1, certaines fonctionnalités modernes (plugins, `profiles`, intégration native) n’étaient pas supportées.
* Sur certains serveurs Ubuntu, l’installation par défaut amenait encore `docker-compose v1`, ce qui provoquait des erreurs lors de l’exécution dans le workflow.
* La solution a été de forcer l’installation de **Docker Compose v2 via le paquet officiel Docker** :

  ```bash
  apt-get install -y docker-compose-plugin
  ```

👉 Désormais, nous utilisons **`docker compose` (sans tiret)** partout, ce qui évite les ambiguïtés et garantit la compatibilité avec les workflows modernes.

🔗 **Documentation officielle**

* Docker : [Overview of Docker Compose](https://docs.docker.com/compose/)
* Docker : [Migrate to Compose V2](https://docs.docker.com/compose/migrate/)
* Docker GitHub : [docker/compose](https://github.com/docker/compose) (repo historique de v1, archivé en grande partie)
* Docker GitHub : [compose-cli](https://github.com/docker/compose-cli) (plugin officiel v2)

---

🔗 **Articles de référence**

* Docker Blog : [Docker Compose V2 General Availability](https://www.docker.com/blog/announcing-compose-v2-general-availability/)
* Dev.to : [Docker Compose V1 vs V2: What’s New and How to Upgrade](https://dev.to/azure/docker-compose-v1-vs-v2-whats-new-and-how-to-upgrade-4k38)
* Medium : [Migrating from docker-compose (v1) to Docker Compose v2](https://medium.com/geekculture/migrating-from-docker-compose-v1-to-docker-compose-v2-195ba5fbc396)

---

## 🌐 5. Services qui ne répondent pas aux healthchecks

### 🔍 Le problème

Les healthchecks se basent sur des endpoints simples (`/-/ready`, `/ready`, `/login`).
👉 Si le service met plus de temps que prévu à démarrer, l’action échoue.

### ⚠️ Symptômes

* Workflow rouge alors que les services finissent par être disponibles.
* `curl: (7) Failed to connect` ou `connection refused`.

### 💡 Solutions

* Ajouter un retry avec délai (exemple : 3 tentatives avec `sleep 5`).
* Adapter les checks si besoin (Grafana → `/api/health`).

---

## 🚨 6. Conflit avec des services manuels

### 🔍 Le problème

Si quelqu’un lance manuellement `docker run` ou modifie des configs directement sur le serveur, le workflow peut casser ces changements.

### ⚠️ Symptômes

* Conteneurs “orphelins” arrêtés automatiquement (`docker compose down --remove-orphans`).
* Configs locales écrasées par `rsync --delete`.

### 💡 Solutions

* Définir une règle : **ne rien modifier en direct sur le serveur**.
* Si besoin de tests → travailler dans une branche GitHub et déployer sur un serveur de staging.

---

## 🔐 7. Sécurité SSH

### 🔍 Le problème

L’utilisation du compte `root` + mot de passe dans GitHub Actions est pratique mais risquée.

### ⚠️ Symptômes

* Tentatives de brute force dans `auth.log`.
* Fail2ban qui bloque l’IP du runner GitHub.

### 💡 Solutions

* Créer un utilisateur `deploy` dédié avec `sudo` restreint.
* Passer à **SSH par clé privée** plutôt que mot de passe.
* Changer le port SSH et activer `fail2ban`.

---

## 🧠 En résumé

Les erreurs fréquentes concernent :

1. **Grafana provisioning** → conflits avec la DB interne.
2. **Secrets mal configurés** → workflow échoue.
3. **Volumes persistants** → perte de données si mal gérés.
4. **Erreurs Docker Compose** → déploiement bloqué.
5. **Services lents** → healthchecks échouent trop vite.
6. **Conflits serveur** → GitHub Actions écrase les configs locales.
7. **Sécurité SSH** → root + password = provisoire seulement.

👉 L’approche idéale : **GitOps strict** (Git = vérité absolue), secrets bien gérés, volumes protégés, et serveur “stateless” (toute modif repassera par Git).

# 6.0 â€“ DÃ©pannage rapide ğŸš‘

MÃªme avec une pipeline bien rodÃ©e, certains problÃ¨mes peuvent bloquer le dÃ©ploiement ou faire croire que la stack ne fonctionne pas. Voici un guide pratique pour diagnostiquer rapidement.

---

## ğŸ” 6.1 Debug listing (vÃ©rification des fichiers dÃ©ployÃ©s)

**SymptÃ´me :**
AprÃ¨s un `docker compose up`, Grafana ou Prometheus semblent fonctionner avec dâ€™anciennes configs ou pas du tout.

**Cause probable :**
Les fichiers nâ€™ont pas Ã©tÃ© correctement synchronisÃ©s depuis le repo â†’ `/root/sentinel/` sur le serveur ne correspond pas au repo GitHub.

**Solution :**
ExÃ©cuter un `ls -la` sur le serveur pour vÃ©rifier le contenu :

```bash
ssh root@server
ls -la /root/sentinel
```

VÃ©rifier que les fichiers modifiÃ©s en local sont bien prÃ©sents.
ğŸ‘‰ Si non, câ€™est que **lâ€™Ã©tape Rsync a Ã©chouÃ©** â†’ relancer manuellement ou checker lâ€™action GitHub.

---

## ğŸ”„ 6.2 Erreur `rsync`

**SymptÃ´me :**
CI/CD Ã©choue avec un message du type :

```
rsync: change_dir "sentinel" failed: No such file or directory
```

**Causes possibles :**

1. Le chemin du dossier `sentinel/` nâ€™existe pas dans le repo.
2. ProblÃ¨me de credentials SSH (mot de passe / clÃ© invalide).
3. Conflit de droits sur le serveur.

**Solutions :**

* VÃ©rifier que le repo contient bien `sentinel/` Ã  la racine.
* Corriger les secrets GitHub (`SSH_USER`, `SSH_PASSWORD`).
* VÃ©rifier les droits sur `/root/sentinel` :

  ```bash
  ls -ld /root/sentinel
  ```

---

## ğŸ“Š 6.3 Datasource Grafana manquante

**SymptÃ´me :**
Dans Grafana, les dashboards affichent "Datasource not found".

**Causes possibles :**

* Le fichier `grafana/provisioning/datasources/datasource.yml` est absent ou mal Ã©crit.
* Provisioning dÃ©sactivÃ© / mauvais chemin montÃ© dans `docker-compose.yml`.
* Les datasources existantes sont encore en **base SQLite** (Grafana garde en DB mÃªme si le YAML est supprimÃ©).
* Regarder 6.6 plus bas

**Solutions :**

1. VÃ©rifier que le fichier YAML est bien copiÃ© dans le conteneur :

   ```bash
   docker exec -it grafana ls /etc/grafana/provisioning/datasources
   ```
2. VÃ©rifier les logs Grafana pour une erreur de provisioning :

   ```bash
   docker logs grafana | grep provisioning
   ```
3. Si Grafana garde une ancienne datasource en DB â†’ supprimer manuellement dans lâ€™interface et redÃ©marrer.

---

## ğŸš¦ 6.4 Services non *ready*

**SymptÃ´me :**
Les checks retournent une erreur :

```
curl: (7) Failed to connect to localhost port 3100: Connection refused
```

**Causes possibles :**

* Service en crash (ex : Loki avec mauvaise config).
* Port dÃ©jÃ  occupÃ© sur le serveur.
* Container ne dÃ©marre pas faute de ressources (RAM, disque).

**Solutions :**

1. Inspecter lâ€™Ã©tat des conteneurs :

   ```bash
   docker compose ps
   ```
2. Lire les logs du conteneur fautif :

   ```bash
   docker logs loki
   docker logs prometheus
   ```
3. VÃ©rifier que le port nâ€™est pas utilisÃ© :

   ```bash
   netstat -tulpn | grep 3100
   ```

---

## ğŸ“œ 6.5 YAML provisioning non appliquÃ©

**SymptÃ´me :**
Un dashboard, une rÃ¨gle dâ€™alerte ou un contact point dÃ©fini en YAML nâ€™apparaÃ®t pas dans Grafana.

**Causes possibles :**

* Erreur de syntaxe YAML (indentation, tabulation).
* Mauvais rÃ©pertoire montÃ© dans `docker-compose.yml`.
* Grafana a chargÃ© le fichier mais lâ€™a ignorÃ© (ex : `apiVersion` manquant).

**Solutions :**

1. VÃ©rifier les logs Grafana :

   ```bash
   docker logs grafana | grep error
   ```
2. Tester la validitÃ© YAML en local :

   ```bash
   yamllint grafana/provisioning/alerting/rules/nginx-rules.yml
   ```
3. Forcer un redÃ©marrage Grafana pour recharger le provisioning.

---

## ğŸ“¦ 6.6 Volumes bindÃ©s et persistance des donnÃ©es

**RÃ´le des volumes bindÃ©s :**
Dans notre `docker-compose.yml`, plusieurs services utilisent des volumes **montÃ©s (bind)** pour persister ou Ã©changer des donnÃ©es entre le host et les conteneurs.
Cela permet de :

* Conserver les donnÃ©es mÃªme aprÃ¨s un `docker compose down`.
* Inspecter directement les fichiers depuis le serveur.
* Versionner uniquement la config YAML sans perdre les donnÃ©es runtime.

---

### ğŸ” Volumes Ã  surveiller

1. **Grafana**

    * GÃ©nÃ©ralement montÃ© sur `/var/lib/grafana` (persistance des dashboards, utilisateurs, alertes en DB SQLite).
    * âš ï¸ MÃªme si un fichier YAML de provisioning est supprimÃ©, Grafana garde la datasource/alerte en DB.

   ```bash
   docker exec -it grafana ls /var/lib/grafana
   ```

2. **Prometheus**

    * Persiste ses mÃ©triques sur `/prometheus` ou `/var/lib/prometheus`.
    * Si ce volume est supprimÃ©, toutes les mÃ©triques sont perdues.

   ```bash
   docker exec -it prometheus ls /prometheus
   ```

3. **Loki**

    * Peut stocker ses chunks et index dans `/loki`.
    * En mode simple, perte des logs si le volume est vidÃ©.

   ```bash
   docker exec -it loki ls /loki
   ```

4. **Fluent Bit**

    * Utilise un bind vers `/var/lib/docker/containers/` et `/var/log/` pour lire les logs du host.
    * Si ce montage nâ€™est pas prÃ©sent, **aucun log nâ€™arrivera dans Loki**.

   ```bash
   ls /var/lib/docker/containers/ | head
   ```

---

### ğŸš¨ ProblÃ¨mes frÃ©quents liÃ©s aux volumes

* **DonnÃ©es persistantes malgrÃ© une nouvelle config**
  â†’ Exemple : Grafana garde dâ€™anciennes datasources en DB.
  âœ… Solution : vider ou recrÃ©er le volume si nÃ©cessaire.

* **Logs manquants dans Loki**
  â†’ Souvent dÃ» Ã  un bind manquant (`/var/lib/docker/containers`).
  âœ… VÃ©rifier les montages avec :

  ```bash
  docker inspect fluent-bit | grep Mounts -A 10
  ```

* **Disque saturÃ©**
  â†’ Prometheus et Loki stockent Ã©normÃ©ment de donnÃ©es.
  âœ… Nettoyer les volumes rÃ©guliÃ¨rement si la rÃ©tention est trop longue.

---

### ğŸ’¡ Bonnes pratiques

* Toujours documenter **oÃ¹ sont montÃ©s les volumes** dans le `compose.yml`.
* Utiliser des volumes Docker **nommÃ©s** (`volumes:`) plutÃ´t que des chemins absolus quand possible.
* Pour tester une nouvelle config : **ne pas supprimer les volumes bindÃ©s** si on veut garder lâ€™historique.
* Pour repartir Ã  zÃ©ro : faire un

  ```bash
  docker compose down -v
  ```

---


## âœ… Bonnes pratiques de dÃ©pannage

* Toujours commencer par un `docker compose ps` + `docker logs` pour voir lâ€™Ã©tat rÃ©el.
* Ajouter des **`echo` clairs dans les scripts CI/CD** pour suivre les Ã©tapes.
* En cas de doute sur Grafana : supprimer son volume (âš ï¸ pertes dashboards manuels) pour forcer un reset provisioning.
* Garder des **dashboards JSON exportÃ©s** versionnÃ©s dans le repo (comme `products-logs.json`).

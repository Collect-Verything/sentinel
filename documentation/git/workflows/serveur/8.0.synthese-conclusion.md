# 📘 8.0 – Synthèse & Conclusion : Workflow Sentinel Monitoring

---

## 🎯 Objectif global

Le workflow `deploy-sentinel-monitoring.yml` a pour but de garantir que **toute modification du dossier Sentinel dans le repo est automatiquement appliquée sur le serveur Sentinel**.
Il répond à plusieurs enjeux :

* **Automatisation** : plus besoin de configurer Grafana, Prometheus ou Loki directement sur le serveur à la main.
* **Versioning** : la configuration (dashboards, datasources, alertes, compose.yml…) est versionnée dans Git.
* **Reproductibilité** : en un seul `push`, on est certain que le serveur applique la dernière configuration validée.
* **Fiabilité** : grâce aux health checks, on vérifie que les services critiques (Prometheus, Grafana, Loki) sont bien démarrés.

---

## 🔑 Fonctionnement en résumé

1. **Déclenchement**

    * Manuel (`workflow_dispatch`) → test ponctuel.
    * Automatique (`push`) → dès qu’une modification est faite dans `sentinel/`.

2. **Concurrence**

    * Un seul déploiement en cours à la fois (`concurrency`).
    * Si un nouveau push arrive, l’ancien déploiement est annulé.

3. **Secrets & Variables**

    * Variables : IP/host du serveur, user SSH.
    * Secrets : mot de passe SSH, mot de passe SMTP Grafana.
    * Tout est injecté dans l’environnement **uniquement pendant l’exécution** → aucune fuite publique.

4. **Bootstrap**

    * Vérifie que le serveur est à jour (`apt-get update/upgrade`).
    * Installe Docker Engine + Compose v2 s’ils ne sont pas déjà là.
    * Cette étape est **idempotente** → réexécutable sans casser l’existant.

5. **Synchronisation**

    * Rsync copie **le dossier `sentinel/` du repo** vers `/root/sentinel/` sur le serveur.
    * Mode `--delete` : supprime les fichiers obsolètes → repo = vérité unique.
    * Garantit que le serveur est **exactement au même état que Git**.

6. **Déploiement**

    * `docker compose config` : validation syntaxique.
    * `docker compose pull` : récupération des images si tag `:latest`.
    * `docker compose down` : arrêt de l’ancienne stack.
    * `docker compose up -d` : lancement de la nouvelle.
    * `docker compose ps` : état final des conteneurs.

7. **Health checks**

    * Vérifie que chaque service est **en état de fonctionner** :

        * Prometheus → `/ready`
        * Loki → `/ready`
        * Grafana → `/login`

---

## 🛡️ Garanties apportées

* **Pas d’écart entre repo et serveur** : ce qui est en Git est la seule source de vérité.
* **Rollback simple** : revenir à une version précédente = faire un `git revert` puis redeployer.
* **Sécurité** : aucun secret sensible n’est versionné en clair, tout est stocké dans GitHub Secrets.
* **Observabilité** : en cas de problème, les logs du workflow et les logs Docker permettent de diagnostiquer rapidement.

---

## ⚠️ Points d’attention

* **Grafana et les données persistées**
  → Certaines configurations (datasources, users, dashboards créés manuellement) sont stockées en **DB SQLite dans `/var/lib/grafana`**.
  → Même si le YAML est supprimé, Grafana garde parfois ces données → il faut gérer les volumes si on veut un vrai reset.

* **Prometheus / Loki et la rétention**
  → Les volumes peuvent grossir très vite.
  → Penser à configurer la rétention (`--storage.tsdb.retention.time` pour Prometheus).

* **Docker Compose v2**
  → Indispensable pour éviter les erreurs de compatibilité (`docker compose` au lieu de `docker-compose`).
  → Corrige des problèmes rencontrés pendant nos premiers tests.

---

## 🚀 Bonnes pratiques d’utilisation

* Toujours passer par Git pour modifier la config → **ne jamais éditer directement sur le serveur**.
* Ajouter une documentation interne quand on crée un nouveau dashboard, une nouvelle règle ou une nouvelle datasource.
* Préférer des **tags versionnés** (ex : `grafana/grafana:12.1.1`) plutôt que `:latest` pour plus de stabilité.
* Automatiser progressivement d’autres aspects (sécurité SSH, Fail2ban, Ansible pour multi-serveurs, etc.).

---

## 📅 Roadmap associée

* [x] Stack de monitoring versionnée et déployée automatiquement.
* [ ] Sécurisation SSH (pas de root login, clé obligatoire).
* [ ] Gestion des alertes plus fine (routing par sévérité, canaux multiples).
* [ ] Ajout Ansible pour initialiser de nouveaux serveurs automatiquement.
* [ ] Développement d’un **front (React)** + **back (NestJS)** pour piloter les déploiements Sentinel.

---

👉 Cette fiche marque la fin du **cycle "automatisation Sentinel Monitoring"** : on a maintenant une stack robuste, versionnée, et prête à évoluer.
